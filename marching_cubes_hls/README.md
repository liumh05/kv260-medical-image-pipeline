# Marching Cubes HLS

基于HLS的Marching Cubes算法实现，用于从三维体数据中提取等值面网格。输入为NPY格式的体数据文件，输出为VTK格式的网格文件。

## 项目结构

```
marching_cubes_hls/
├── hls_src/
│   ├── marching_cubes_hls.h      # HLS顶层接口定义
│   ├── marching_cubes_hls.cpp    # Marching Cubes算法实现
│   ├── mc_tables.h               # Marching Cubes查找表
│   └── mc_tables.cpp             # 查找表数据
├── hls_testbench/
│   ├── test_marching_cubes_hls.cpp # 测试平台主程序
│   ├── npy_reader.h              # NPY文件读取器
│   ├── npy_reader.cpp            # NPY文件解析实现
│   ├── vtk_writer.h              # VTK文件写入器
│   └── vtk_writer.cpp            # VTK文件输出实现
├── vivado_design/
│   └── design_1.tcl              # Vivado Block Design脚本
└── vtk_render/
    └── pyvista_render.ipynb      # PyVista可视化示例
```

## 功能特性

- **硬件加速**：基于FPGA的并行处理实现
- **流式处理**：使用HLS Stream进行高效数据传输
- **内存优化**：双层缓存机制减少外部存储访问
- **标准接口**：支持NPY输入和VTK输出格式

## 技术规格

- **最大体数据尺寸**：128×128×128
- **最大顶点数**：1,000,000
- **最大三角形数**：2,000,000
- **数据类型**：float32
- **处理方式**：流式处理

## 算法原理

### Marching Cubes算法
Marching Cubes是一种经典的等值面提取算法，通过遍历体数据中的每个立方体单元，根据顶点值与等值的关系生成三角形面片。

### 核心步骤

1. **立方体分类**：根据8个顶点值与等值的关系确定立方体配置
2. **顶点插值**：在边上通过线性插值计算等值面与边的交点
3. **三角形生成**：基于查找表生成三角形面片
4. **流式输出**：将顶点和三角形通过Stream接口输出

### 优化策略

- **查找表加速**：使用预计算的边表和三角形表
- **缓存机制**：双层Z缓存减少内存访问
- **流水线处理**：通过HLS指令实现流水线优化

## 配置参数

可通过修改头文件中的宏定义调整配置：

```cpp
#define MAX_DIM 128              // 最大体数据维度
#define MAX_VERTICES 1000000     // 最大顶点数
#define MAX_TRIANGLES 2000000    // 最大三角形数
```

## 接口说明

### 顶层接口

```cpp
void marching_cubes_hls(
    const data_t* volume,           // 输入体数据
    int nx, int ny, nz,            // 体数据尺寸
    data_t isovalue,               // 等值
    hls::stream<Vertex>& vertex_stream,     // 顶点输出流
    hls::stream<Triangle>& triangle_stream, // 三角形输出流
    int* num_vertices,             // 顶点数量
    int* num_triangles             // 三角形数量
);
```

### 数据结构

```cpp
struct Vertex {
    vertex_t x, y, z;              // 顶点坐标
};

struct Triangle {
    index_t v0, v1, v2;            // 三角形顶点索引
};
```

## 使用方法

### 1. HLS综合

```bash
# 在Vitis HLS中打开项目
cd hls_src
vitis_hls -p marching_cubes_hls
```

### 2. 仿真测试

```bash
# 编译测试平台
cd hls_testbench
g++ -I../hls_src test_marching_cubes_hls.cpp npy_reader.cpp vtk_writer.cpp -o test_mc

# 运行测试
./test_mc input.npy 0.5 output.vtk
```

### 3. 参数说明

```bash
./test_mc <input.npy> <isovalue> <output.vtk> [--with-normals]
```

参数说明：
- `input.npy`: 输入NPY文件，形状为(1, D, H, W)或(D, H, W)
- `isovalue`: 等值，用于表面提取
- `output.vtk`: 输出VTK文件路径
- `--with-normals`: (可选)输出包含法向量的VTK文件

### 4. Vivado集成

```bash
# 导入IP到Vivado
source vivado_design/design_1.tcl
```

## 输入格式

### NPY文件要求
- **数据类型**：float32
- **形状**：(1, D, H, W) 或 (D, H, W)
- **字节序**：C-order（行优先）
- **维度限制**：D, H, W ≤ 128

### 支持的数据类型转换
- float32：直接使用
- int16/int32：自动转换为float32
- uint8：自动转换为float32

## 输出格式

### VTK Legacy PolyData格式
输出文件包含：
- 点数据：顶点坐标(x, y, z)
- 面数据：三角形面片（三个顶点索引）
- 法向量：可选的法向量数据

### 文件结构
```
# vtk DataFile Version 3.0
Generated by Marching Cubes HLS
ASCII
DATASET POLYDATA
POINTS <count> float
<vertex coordinates>
POLYGONS <count> <data_size>
<triangle indices>
```

## 性能优化

### HLS优化指令

- `#pragma HLS PIPELINE`: 实现流水线处理
- `#pragma HLS INLINE`: 内联函数优化
- `#pragma HLS ARRAY_PARTITION`: 数组分区优化

### 内存访问优化

- **双缓存机制**：减少存储冲突
- **局部性优化**：提高缓存命中率
- **Burst传输**：优化数据传输效率

## 注意事项

1. **内存限制**：受FPGA片上存储限制，最大支持128³体数据
2. **边界处理**：自动处理体数据边界情况
3. **数值精度**：使用float32精度，注意浮点运算误差
4. **查找表**：确保使用完整的Marching Cubes查找表

## 调试与验证

### 功能验证
- 使用球体、立方体等标准几何体进行验证
- 与C++参考实现对比结果正确性
- 通过PyVista等工具可视化验证输出

### 性能分析
- 使用Vivado HLS分析工具查看资源使用
- 监控流水线吞吐率和延迟
- 优化关键路径提高工作频率

## 扩展功能

### 支持的扩展
- **各向异性间距**：支持不同方向的体素间距
- **法向量计算**：自动计算表面法向量
- **多等值面**：支持同时提取多个等值面
- **数据压缩**：支持压缩格式的体数据输入
